<!--
 * @Description: 
 * @code: 
 * @Author: Li Jiaxin
 * @Date: 2023-07-28 21:32:30
 * @LastEditors: Li Jiaxin
 * @LastEditTime: 2023-07-30 22:36:31
-->
# 单片机开发产品流程
常见的开发流程如图所示：
<img decoding="async" src="pic\单片机开发流程.png">

1. 明确任务
   - 分析和了解项目的总体要求，并综合考虑系统使用环境、可靠性要求、可维护性及产品的成本等因素，制定出可行的性能指标。
  
2. 划分软、硬件功能
    - 单片机系统由软件和硬件两部分组成。在应用系统中，有些功能既可由硬件来实现，也可以用软件来完成。硬件的使用可以提高系统的实时性和可靠性;使用软件实现，可以降低系统成本，简化硬件结构。因此在总体考虑时，必须综合分析以上因素，合理地制定硬件和软件任务的比例。

3. 确定希望使用的单片机及其他关键部件
   - 根据硬件设计任务，选择能够满足系统需求并且性价比高的单片机及其他关键器件，如A/D、D/A转换器、传感器、放大器等，这些器件需要满足系统精度、速度以及可靠性等方面的要求。

4. 硬件设计
   - 根据总体设计要求，以及选定的单片机及关键器件，利用Protel等软件设计出应用系统的电路原理图。

5. 软件设计
   - 在系统整体设计和硬件设计的基础上，确定软件系统的程序结构并划分功能模块，然后进行各模块程序设计。

6. 仿真调试
   - 软件和硬件设计结束后，需要进行进行进入两者的整合调试阶段。为避免浪费资源，在生成实际电路板之前，可以利用Keil C51和Proteus软件进行系统仿真，出现问题可以及时修改。

7. 系统调试

8. 测试修改、用户试用

单片机程序设计语言：

- 机器语言：称为二进制目标代码，是CPU硬件唯一能够直接识别的语言(在设计CPU时就已经确定其代码的含义)。人们要计算机所执行的所有操作，最终都必须转换成为相应的机器语言由CPU识别、控制执行。CPU系列不同，其机器语言代码的含义也不尽相同。
- 汇编语言：由于机器语言必须转换为二进制代码描述，不便于记忆、使用和直接编写程序，为此产生了与机器语言相对应的汇编语言。用汇编语言编写的程序执行速度快，占用存储单元少，效率高。
- 高级语言：c语言

学习方法：
- 掌握开发单片机的必备基础知识：首先是熟练掌握单片机的基本原理，虽然现在单片机厂商众多，但各家单片机的基本结构和原理都比较相近，例如**内核结构、内存分配、中断处理、定时计数、串行通信、端口复用**等一些最基本的概念和原理。

# MCU介绍

**概念**：MCU是Microcontroller Unit的简称，中文叫做微控制器，俗称单片机，是把CPU的频率和规格做适当缩减，并将内存、计数器、USB、A\D转换、UART、PLC、DMA等周边接口，甚至LCD驱动电路整合到单一芯片上，形成的芯片级计算机，为不同的应用场合做不同组合控制，诸如手机、PC外围、遥控器，至汽车电子、工业上的步进马达、机器手臂的控制等，都可见到MCU的身影。

分类：
- MCU按照存储类型可以分为无片内ROM型和带片内ROM型两种。对于无片内ROM型的芯片，必须外接EPROM才能应用（典型为8031）；带片内ROM型的芯片又分为片内EPROM型（典型芯片为87C51）、MASK片内掩模ROM型（典型芯片为8051）、片内Flash型（典型芯片为89C51）等类型。
- 按用途可分为通用型和专用型；根据数据总线的宽度和一次可处理的数据字节长度可分为8、16、32位MCU。

基本功能：
- Timer定时器：TImer的种类虽然比较多，但可归纳为两大类：**一类是固定时间间隔的TImer**，即其定时的时间是由系统设定的，用户程序不可控制，系统只提供几种固定的时间间隔给用户程序进行选择，如32Hz，16Hz，8Hz等，此类TImer在4位MCU中比较常见，因此可以用来实现时钟、计时等相关的功能。**另一类则是Programmable Timer(可编程定时器)**，顾名思义，该类Timer的定时时间是可以由用户的程序来控制的，控制的方式包括：时钟源的选择、分频数(Prescale)选择及预制数的设定等，有的MCU三者都同时具备，而有的则可能是其中的一种或两种。此类Timer应用非常灵活，实际的使用也千变万化，其中最常见的一种应用就是用其实现PWM输出。由于时钟源可以自由选择，因此，此类Timer一般均与Event Counter(事件计数器)合在一起。

- IO口：任何MCU都具有一定数量的IO口，没有IO口，MCU就失去了与外部沟通的渠道。根据IO口的可配置情况，可以分为如下几种类型
  - 纯输入或纯输出口：此类IO口由MCU硬件设计决定，只能是输入或输出，不可用软件来进行实时的设定。
  - 直接读写IO口：如MCS-51的IO口就属于此类IO口。当执行读IO口指令时，就是输入口;当执行写IO口指令则自动为输出口。
  - 程序编程设定输入输出方向的：此类IO口的输入或输出由程序根据实际的需要来进行设定，应用比较灵活，可以实现一些总线级的应用，如I2C总线，各种LCD、LED Driver的控制总线等。
  - 对于IO口的使用，重要的一点必须牢记的是：对于输入口，必须有明确的电平信号，确保不能浮空(可以通过增加上拉或下拉电阻来实现);而对于输出口，其输出的状态电平必须考虑其外部的连接情况，应保证在Standby或静态状态下不存在拉电流或灌电流。

- 外部中断：外部中断也是绝大多数MCU所具有的基本功能，一般用于信号的实时触发，数据采样和状态的检测，中断的方式由上升沿、下降沿触发和电平触发几种。外部中断一般通过输入口来实现，若为IO口，则只有设为输入时其中断功能才会开启;若为输出口，则外部中断功能将自动关闭(ATMEL的ATiny系列存在一些例外，输出口时也能触发中断功能)。外部中断的应用如下：
  - 外部触发信号的检测：一种是基于实时性的要求，比如可控硅的控制，突发性信号的检测等，而另一种情况则是省电的需要。
  - 信号频率的测量：为了保证信号不被遗漏，外部中断是最理想的选择。
  - 数据的解码：在遥控应用领域，为了降低设计的成本，经常需要采用软件的方式来对各种编码数据进行解码，如Manchester和PWM编码的解码。
  - 按键的检测和系统的唤醒：对于进入Sleep状态的MCU，一般需要通过外部中断来进行唤醒，最基本的形式则是按键，通过按键的动作来产生电平的变化。

- 通讯接口：MCU所提供的通讯接口一般包括SPI接口，UART，I2C接口等，其分别描述如下：
  - SPI接口：此类接口是绝大多数MCU都提供的一种最基本通讯方式，其数据传输采用同步时钟来控制，信号包括：SDI(串行数据输入)、SDO(串行数据输出)、SCLK(串行时钟)及Ready信号;有些情况下则可能没有Ready信号;此类接口可以工作在Master方式或Slave方式下，通俗说法就是看谁提供时钟信号，提供时钟的一方为Master，相反的一方则为Slaver。
  - URAT：Universal Asynchronous Receive Transmit，属于最基本的一种异步传输接口，其信号线只有Rx和Tx两条，基本的数据格式为：Start Bit + Data Bit(7-bits/8-bits) + Parity Bit(Even， Odd or None) + Stop Bit(1~2Bit)。一位数据所占的时间称为Baud Rate(波特率)。对于大多数的MCU来讲，数据位的长度、数据校验方式(奇校验、偶校验或无校验)、停止位(Stop Bit)的长度及Baud Rate是可以通过程序编程进行灵活设定。此类接口最常用的方式就是与PC机的串口进行数据通讯。
  - I2C：I2C是由Philips开发的一种数据传输协议，同样采用2根信号来实现：SDAT(串行数据输入输出)和SCLK(串行时钟)。其最大的好处是可以在此总线上挂接多个设备，通过地址来进行识别和访问;I2C总线的一个最大的好处就是非常方便用软件通过IO口来实现，其传输的数据速率完全由SCLK来控制，可快可慢，不像UART接口，有严格的速率要求。
  - watch dog：Watchdog也是绝大多数MCU的一种基本配置(一些4位MCU可能没有此功能)，大多数的MCU的Watchdog只能允许程序对其进行复位而不能对其关闭(有的是在程序烧入时来设定的，如Microchip PIC系列MCU)，而有的MCU则是通过特定的方式来决定其是否打开，如Samsung的KS57系列，只要程序访问了Watchdog寄存器，就自动开启且不能再被关闭。一般而言watchdog的复位时间是可以程序来设定的。Watchdog的最基本的应用是为MCU因为意外的故障而导致死机提供了一种自我恢复的能力。

- 学习窍门：任何一款MCU，其基本原理和功能都是大同小异，所不同的只是其外围功能模块的配置及数量、指令系统等。对于指令系统，虽然形式上看似千差万别，但实际上只是符号的不同，其所代表的含义、所要完成的功能和寻址方式基本上是类似的。
要了解一款MCU，首先需要知道就是其ROM空间、RAM空间、IO口数量、定时器数量和定时方式、所提供的外围功能模块（Peripheral Circuit）、中断源、工作电压及功耗等等。


**单片机程序书写** 

1. 初始化：对于所有的MCU程序的设计来讲，初始化是最基本也是最重要的一步，一般包括如下内容：
   - 屏蔽所有中断并初始化堆栈指针：初始化部分一般不希望有任何中断发生。
   - 清除系统的RAM区域和显示Memory：虽然有时可能没有完全的必要，但从可靠性及一致性的角度出发，特别是对于防止意外的错误，还是建议养成良好的编程习惯。
   - IO口的初始化：根据项目的应用的要求，设定相关IO口的输入输出方式，对于输入口，需要设定其上拉或下拉电阻;对于输出口，则必须设定其初始的电平输出，以防出现不必要的错误。
   - 中断的设置：对于所有项目需要用到的中断源，应该给予开启并设定中断的触发条件，而对于不使用的多余的中断，则必须给予关闭。
   - 其他功能模块的初始化：对于所有需要用到的MCU的外围功能模块，必须按项目的应用的要求进行相应的设置，如UART的通讯，需要设定Baud Rate，数据长度，校验方式和Stop Bit的长度等，而对于Programmer Timer，则必须设置其时钟源，分频数及Reload Data等。
   - 参数的初始化：完成了MCU的硬件和资源的初始化后，接下来就是对程序中使用到的一些变量和数据的初始化设置，这一部分的初始化需要根据具体的项目及程序的总体安排来设计。对于一些用EEPROM来保存项目预制数的应用来讲，建议在初始化时将相关的数据拷贝到MCU的RAM，以提高程序对数据的访问速度，同时降低系统的功耗（原则上，访问外部EEPROM都会增加电源的功耗）。

2. 主程序循环体：大多数MCU是属于长时间不间断运行的，因此其主程序体基本上都是以循环的方式来设计，对于存在多种工作模式的应用来讲，则可能存在多个循环体，相互之间通过状态标志来进行转换。对于主程序体，一般情况下主要安排如下的模块：
   - 计算程序：计算程序一般比较耗时，因此坚决反对放在任何中断中处理，特别是乘除法运算。
   - 显示传输程序：主要针对存在外部LED、LCD Driver的应用。

3. 中断处理程序：中断程序主要用于处理实时性要求较高的任务和事件，如，外部突发性信号的检测，按键的检测和处理，定时计数，LED显示扫描等。一般情况下，中断程序应尽可能保证代码的简洁和短小，对于不需要实时去处理的功能，可以在中断中设置触发的标志，然后由主程序来执行具体的事务――这一点非常重要，特别是对于低功耗、低速的MCU来讲，必须保证所有中断的及时响应。

4. 对于不同任务体的安排，不同的MCU其处理的方法也有所不同：例如，对于低速、低功耗的MCU(Fosc=32768Hz)应用，考虑到此类项目均为手持式设备和采用普通的LCD显示，对按键的反应和显示的反应要求实时性较高，因此一般采用定时中断的方式来处理按键的动作和数据的显示；而对于高速的MCU，如Fosc》1MHz的应用，由于此时MCU有足够的时间来执行主程序循环体，因此可以只在相应的中断中设置各种触发标志，并将所有的任务放在主程序体中来执行。

5. 要防止在中断和主程序体中同时访问或设置同一个变量或数据的情况。有效的预防方法是，将此类数据的处理安排在一个模块中，通过判断触发标志来决定是否执行该数据的相关操作；而在其他的程序体中(主要是中断)，对需要进行该数据的处理的地方只设置触发的标志。――这可以保证数据的执行是可预知和唯一的。